<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2 vs 2</title>
<link rel="icon" type="image/png" href="/assets/ug ds logo favicon.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@100..900&family=Saira:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">


<style>

:root {
  --bg: #041016;
  --accent: #FF4633;
  --text: #fff;
  --photo-size: 90vmin;
  --blur: 20px;
  --transition: 1s cubic-bezier(.22,1,.36,1);
  --selection-bg: #FF4633;
  --selection-text: #fff;
}
*{box-sizing:border-box;}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow:hidden;}
.slides{position:relative;width:100%;height:100%;  font-family: "Noto Sans Georgian", sans-serif;}

/* === Base Slide Animation === */
.slide{
  position:absolute;inset:0;display:grid;place-items:center;
  opacity:0;transform:translateY(60px);filter:blur(var(--blur));overflow: hidden;
  transition: opacity var(--transition), transform var(--transition), filter var(--transition), background-color 0.4s ease;
  pointer-events: none;
}
.slide.active{opacity:1;transform:translateY(0);filter:none;overflow: hidden; pointer-events: auto;}
.slide.exit{opacity:0;transform:translateY(-60px);filter:blur(var(--blur));overflow: hidden;}

/* === Slide 1 (center photo) === */
#slide-1 img, #slide-4 img {
  width:var(--photo-size);height:var(--photo-size);
  object-fit:contain;border-radius:0;
  opacity:0;transform:scale(0.8);filter:blur(10px);
  transition:opacity 1.2s ease,transform 1s ease,filter 1.2s ease;
}
#slide-1.active img, #slide-4.active img {
  opacity:1;transform:scale(1);filter:blur(0);
}


#slide-2 {
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: var(--bg);
}

/* === Slide 2 (fullscreen image) === */
#slide-2 img {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  object-position: center;
  background-color: var(--bg);
}

/* === Slide 4 (Timer) === */
.timer {
  font-family: "Saira", sans-serif;
  font-weight: 700;font-variant-numeric: tabular-nums;
  font-size: clamp(48px, 40vmin, 440px);
  letter-spacing: .03em;position:relative;
  display:flex;gap:0.02em;color:var(--text);
  transition:color .3s ease, filter .6s ease, opacity .6s ease;
  transition:color 0.2s ease, filter .6s ease, opacity .6s ease;
}
.timer.paused{color:var(--accent);}
.timer.resetting{
  filter:blur(60px);
  opacity:0;
  transition:filter 1s ease, opacity 1s ease;
}
.timer .digit{position:relative;display:inline-block;width:1ch;text-align:center;}
.digit .prev,.digit .next{
  position:absolute;inset:0;display:flex;justify-content:center;align-items:center;
}
.digit .prev{opacity:1;filter:none;transform:translateY(0);}
.digit .next{opacity:0;filter:blur(20px);transform:translateY(40%);}
.digit.anim .prev{animation:fadeOut .4s ease forwards;}
.digit.anim .next{animation:fadeIn .4s ease forwards;}
@keyframes fadeOut{0%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-40%);filter:blur(10px);} }
@keyframes fadeIn{0%{opacity:0;transform:translateY(40%);filter:blur(10px);}100%{opacity:1;transform:translateY(0);filter:none;}}

/* === Timer End State === */
#slide-5.timer-ended {
  background-color: var(--accent);
}
#slide-5.timer-ended .timer.paused {
  color: var(--bg); /* Change text color for contrast */
}
/* === Slide 5 (QR) === */
.qr-wrap {
  display: grid;
  place-items: center;
  gap: 10px;
  text-align: center;
  height: 100%;
}
.qr-box {
  width: var(--photo-size);
  height: var(--photo-size);
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 0;
  overflow: hidden;
}
.qr-svg {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.qr-text{font-size:4rem;font-weight:800;color:#fff;letter-spacing:2px;margin-top:0;}

.timer-with-photo-container {
  position: relative;
  display: grid;
  place-items: center;
}

.timer-top-image {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    height: 30vmin;
    margin-bottom: 10rem;
}

/* === Placeholder (Slide 6) === */
.placeholder{font-size:clamp(32px,10vmin,120px);font-weight:900;opacity:.8;}

.timer-overlay {
  position: absolute;
  inset: 0;
  backdrop-filter: blur(20px);
  background: rgba(12, 26, 34, 0.3);
  display: grid;
  place-items: center;
  z-index: 10;
  transition: opacity 0.5s ease;
}

.controls-overlay {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  background: rgba(12, 26, 34, 0.75);
  backdrop-filter: blur(20px);
  color: var(--text);
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 99;
}
.controls-overlay.visible {opacity: 1;}
.controls-box {
  background: rgba(0, 0, 0, 0.4);
  border: 2px solid var(--accent);
  border-radius: 12px;
  padding: 2rem 3rem;
  text-align: left;
  font-size: 1.5rem;
  line-height: 1.8;
}
.controls-box h2 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 2rem;
  color: var(--accent);
}
.settings-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 80%;
  max-width: 1000px;
}
.setting {
  display: flex;
  flex-direction: column;
}
.setting label {
  font-size: 1.5rem;
  margin-bottom: 0.6rem;
  font-weight: 600;
}
.setting input {
  font-size: 1.5rem;
  padding: 0.8rem 1rem;
  border-radius: 20px;
  border: 2px solid var(--accent);
  background-color: var(--bg);
  color: #fff;
  font-family: "Noto Sans Georgian", sans-serif;
  max-height: 60px;
}
.setting-horizontal {
  display: flex;
  flex-direction: row;
  gap: 1rem;
  align-items: stretch;
}
.setting-horizontal .setting {
  flex: 1;
  margin-bottom: 0;
}
.setting-horizontal .setting label {
  font-size: 1.2rem; /* Smaller label for sub-fields */
}
.setting-checkbox {
  display: flex;
  align-items: center;
  align-self: flex-end;
  gap: 1rem;
}
.setting-checkbox label {
  font-size: 1.2rem;
  margin-bottom: 0;
}
.setting-checkbox input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  margin: 0;
  width: 60px;
  height: 60px;
  background-color: #21323f;
  border-radius: 20px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  display: grid;
  place-content: center;
}
.setting-checkbox input[type="checkbox"]:checked {
  background-color: var(--accent);
}
.setting-checkbox input[type="checkbox"]::before {
  content: '';
  width: 15px;
  height: 30px;
  border: solid var(--bg);
  border-width: 0 6px 6px 0;
  transform: rotate(45deg) scale(0);
  transition: transform 0.2s ease-in-out;
  transition-delay: 0.1s;
}
.setting-checkbox input[type="checkbox"]:checked::before {
  transform: rotate(45deg) scale(1);
}

.resolution-text {
  font-size: clamp(100px, 8vmin, 120px);
  font-weight: 700;
  text-align: center;
}
.start-prompt {
  position: absolute;
  bottom: 2rem;
  right: 2rem;
  font-size: 2rem;
  color: var(--text);
  opacity: 1;
  text-transform: uppercase;
  font-family: "Saira", sans-serif;
}
.version-display {
    position: absolute;
    bottom: 0.5rem;
    right: 1.5rem;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.2);
    font-family: monospace;
}
.reset-button {
  margin-top: 1rem;
  padding: 0.75rem 1.5rem;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text);
  background-color: var(--accent);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  justify-self: center;
  font-family: "Noto Sans Georgian", sans-serif;
}
.reset-button:hover {
  background-color: #c72a2a;
}
.setting.toggle {
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  margin-top: 20px;
}

.setting.toggle label {
  margin-bottom: 0;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #2a4458;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute; content: ""; height: 26px; width: 26px;
  left: 4px; bottom: 4px; background-color: white;
  transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(26px); }
body.hide-cursor {
  cursor: none;
}
.home-logo-link {
  position: absolute;
  top: 2rem;
  left: 2rem;
  width: 120px;
  z-index: 10;
  transition: transform 0.3s ease;
}
.home-logo-link:hover {
  transform: scale(1.05);
}
.home-logo-link img {
  width: 100%;
}
.mobile-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background-color: var(--bg);
  color: var(--text);
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  font-size: 1.5rem;
  z-index: 1000;
  padding: 2rem;
  font-family: "Noto Sans Georgian", sans-serif;
}
.mobile-overlay-icon {
    font-size: 5rem;
    margin-bottom: 1rem;
}
@media (hover: none) and (pointer: coarse), (max-width: 1200px) {
  .mobile-overlay {
    display: flex;
  }
}
</style>
</head>

<body>
<div class="mobile-overlay">
  <div class="mobile-overlay-icon">⚠️</div>
  <div>This website is not supported on mobile devices. Please use a desktop browser.</div>
</div>
<div class="slides">
  
  <section class="slide active" id="slide-0">
    <a href="index.html" class="home-logo-link">
      <img src="https://raw.githubusercontent.com/ug-ds/ug-ds.github.io/761a9da78b14f5bafe56827eaed0f8e0d54bead8/assets/ug%20ds%20logo%20svg.svg" alt="Home Logo">
    </a>
    <div class="settings-container">
      <div class="setting">
        <label for="res1">პირველი რეზოლუცია</label>
        <input type="text" id="res1" value="R1">
      </div>
      <div class="setting">
        <label for="res2">მეორე რეზოლუცია</label>
        <input type="text" id="res2" value="R2">
      </div>
      <div class="setting">
        <label for="res3">მესამე რეზოლუცია</label>
        <input type="text" id="res3" value="R3">
      </div>
      <div class="setting">
        <label>დრო</label>
        <div class="setting-horizontal">
            <div class="setting">
                <label for="timer-minutes">წუთი</label>
                <input type="number" id="timer-minutes" value="5" min="1" max="59">
            </div>
            <div class="setting-checkbox">
                <label for="test-time-toggle">Test</label>
                <input type="checkbox" id="test-time-toggle">
            </div>
        </div>
    </div>
      <div class="setting toggle">
        <label for="audio-toggle">Enable Audio</label>
        <label class="toggle-switch">
          <input type="checkbox" id="audio-toggle" checked>
          <span class="slider"></span>
        </label>
      </div>
      <button id="reset-settings-btn" class="reset-button">RESET</button>
    </div>
    <div id="remote-control-container" style="position: absolute; bottom: 2rem; left: 2rem; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; z-index: 20; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
      <div id="qr-code-container" style="z-index: 21; order: 1;">
        <a id="qr-code-link" href="https://ug-ds.github.io/remote" target="_blank"><img id="qr-code-img" src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://ug-ds.github.io/remote&color=ED3737&bgcolor=0C1A22&qzone=1" alt="Remote QR Code" style="border: 4px solid var(--accent); border-radius: 8px;"></a>
      </div>
      <div style="order: 2; text-align: center;">
        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; color: var(--accent);">Remote Code</h3>
        <div id="peer-id-display" style="font-family: 'Saira', sans-serif; font-size: 2.5rem; letter-spacing: 3px; color: #fff;">
          ------
        </div>
        <div id="connection-status" style="margin-top: 0.5rem; color: #999; height: 1em;">
          Waiting for connection...
        </div>
      </div>
    </div>
    <div class="start-prompt">press enter to start</div>
    <div class="version-display" id="version-display"></div>
  </section>

  <section class="slide" id="slide-1">
    <div class="resolution-text" id="res-display-1"></div>
  </section>

  <section class="slide" id="slide-2">
    <div class="resolution-text" id="res-display-2"></div>
  </section>

  <section class="slide" id="slide-3">
    <div class="resolution-text" id="res-display-3"></div>
  </section>

  <section class="slide" id="slide-4">
    <img src="https://github.com/David3dArt/UGSTUFF/raw/refs/heads/main/assetsimg/ug%20ds%20logo%20svg%20web%202.svg" alt="UGDS Logo">
  </section>

  <section class="slide" id="slide-5">
    <div class="timer-with-photo-container">
        <img src="https://raw.githubusercontent.com/ug-ds/ug-ds.github.io/761a9da78b14f5bafe56827eaed0f8e0d54bead8/assets/ug%20ds%20logo%20svg.svg" alt="UGDS Logo" class="timer-top-image">
        <div class="timer" id="timer"></div>
    </div>
  </section>

  <section class="slide" id="slide-6">
    <div class="placeholder"></div>
  </section>
</div>

<!-- preload audio elements -->
<audio id="timerTick" src="/sfx/timer%20tick.mp3" preload="auto"></audio>
<audio id="timesup" src="/sfx/times_up.mp3" preload="auto"></audio>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
(function(){
  const slides = document.querySelectorAll(".slide");
  let activeIndex = 0, busy = false, resetting = false;

  // === Cookie functions ===
  function setCookie(name, value, days) {
      let expires = "";
      if (days) {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "")  + expires + "; path=/; SameSite=Lax";
  }

  function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for(let i=0;i < ca.length;i++) {
          let c = ca[i];
          while (c.charAt(0)==' ') c = c.substring(1,c.length);
          if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
      }
      return null;
  }

  // === Get new elements ===
  const res1Input = document.getElementById('res1');
  const res2Input = document.getElementById('res2');
  const res3Input = document.getElementById('res3');
  const timerMinutesInput = document.getElementById('timer-minutes');
  const testTimeToggle = document.getElementById('test-time-toggle');

  const resDisplay1 = document.getElementById('res-display-1');
  const resDisplay2 = document.getElementById('res-display-2');
  const resDisplay3 = document.getElementById('res-display-3');
  const resetButton = document.getElementById('reset-settings-btn');
  const audioToggle = document.getElementById("audio-toggle");

  function saveAudioSetting() {
    setCookie('audioEnabled', audioToggle.checked, 365);
  }

  function loadAudioSetting() {
    const audioEnabled = getCookie('audioEnabled');
    if (audioEnabled !== null) audioToggle.checked = (audioEnabled === 'true');
  }
  audioToggle.addEventListener('change', saveAudioSetting);

  // === Settings functions ===
  function saveSettings() {
      setCookie('res1', res1Input.value, 365);
      setCookie('res2', res2Input.value, 365);
      setCookie('res3', res3Input.value, 365);
      setCookie('timerMinutes', timerMinutesInput.value, 365);
  }

  function loadSettings() {
      const res1 = getCookie('res1');
      if (res1) res1Input.value = res1;

      const res2 = getCookie('res2');
      if (res2) res2Input.value = res2;

      const res3 = getCookie('res3');
      if (res3) res3Input.value = res3;

      const timerMinutes = getCookie('timerMinutes');
      if (timerMinutes) timerMinutesInput.value = timerMinutes;

      updateResolutionDisplays();
      updateTimerFromSettings();
  }

  function resetSettings() {
    res1Input.value = "R1";
    res2Input.value = "R2";
    res3Input.value = "R3";
    timerMinutesInput.value = "5";
    testTimeToggle.checked = false;

    // update displays and save to cookies
    updateResolutionDisplays();
    updateTimerFromSettings();
  }

  // === Update resolution display slides ===
  function updateResolutionDisplays() {
    resDisplay1.textContent = res1Input.value;
    resDisplay2.textContent = res2Input.value;
    resDisplay3.textContent = res3Input.value;
  }

  // === Event listeners for resolution inputs ===
  res1Input.addEventListener('input', () => { updateResolutionDisplays(); saveSettings(); });
  res2Input.addEventListener('input', () => { updateResolutionDisplays(); saveSettings(); });
  res3Input.addEventListener('input', () => { updateResolutionDisplays(); saveSettings(); });
  resetButton.addEventListener('click', resetSettings);
  

  // === preload sounds ===
  const timerTick = document.getElementById("timerTick");
  const timesup = document.getElementById("timesup");
  [timerTick, timesup].forEach(a => a.load());
  const playSound = a => { if(audioToggle.checked) { a.currentTime = 0; a.play().catch(e => console.error("Audio play failed:", e)); } };

  // === slide switching ===
  function showSlide(i) {
    if (busy || i === activeIndex || i < 0 || i >= slides.length) return;
    busy = true;
    const from = slides[activeIndex];
    from.classList.remove("active"); from.classList.add("exit");
    const next = slides[i];
    next.classList.add("active");
    setTimeout(() => { from.classList.remove("exit"); activeIndex = i; busy = false; }, 800);
    if (i === 0) {
      document.body.classList.remove('hide-cursor');
      const t = currentTimer();
      if (t) {
        t.reset();
      }
    } else {
      document.body.classList.add('hide-cursor');
    }
  }

  // === timer factory ===
  function createTimer(slideId, timerId, totalSeconds) {
    const timerEl=document.getElementById(timerId);
    if (!timerEl) return null;
    const slideEl=document.getElementById(slideId);
    let running=false, raf=null, startTimestamp=null, elapsed=0, lastDisplayedSecond = -1;
    let finished=false;
    
    const fmt=sec=>{
      sec=Math.max(sec,0);
      const m=Math.floor(sec/60),s=Math.floor(sec%60);
      return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
    };

    function renderDigits(t){
      timerEl.innerHTML="";
      for(const ch of t){
        const d=document.createElement("div");d.className="digit";
        const p=document.createElement("div");p.className="prev";
        const n=document.createElement("div");n.className="next";
        p.textContent=n.textContent=ch;d.append(p,n);timerEl.appendChild(d);
      }
    }

    function updateDisplay(o,n){
      const ds=timerEl.children;
      for(let i=0;i<ds.length;i++){
        const d=ds[i],p=d.querySelector(".prev"),x=d.querySelector(".next");
        if(o[i]!==n[i]){
          x.textContent=n[i];
          d.classList.add("anim");
          setTimeout(()=>{p.textContent=n[i];d.classList.remove("anim");},400);
        }
      }
    }

    function loop(now){
      if(!running)return;
      const ce=(now-startTimestamp)/1000;
      const rem=Math.max(totalSeconds-ce,0);
      const o=fmt(Math.ceil(totalSeconds-elapsed));
      const n=fmt(Math.ceil(rem));
      if(o!==n){updateDisplay(o,n); if (rem > 0) playSound(timerTick);}
      elapsed=ce;

      if(rem<=0 && !finished){
        finished=true;
        running=false;
        timerEl.classList.add("paused");
        slideEl.classList.add("timer-ended");
        playSound(timesup);
        return;
      }
      raf=requestAnimationFrame(loop);
    }

    function start(){
      if(running || resetting)return;
      finished=false;
      timerEl.classList.remove("paused");
      running=true;
      startTimestamp=performance.now()-elapsed*1000;
      raf=requestAnimationFrame(loop);
    }

    function pause(){
      if(!running)return;
      running=false;
      if(raf)cancelAnimationFrame(raf);
      timerEl.classList.add("paused");
      // No sound should play on pause
    }

    function reset(){
      if(resetting) return;
      if(raf)cancelAnimationFrame(raf);
      running=false;
      finished=false;
      resetting = true;
      slideEl.classList.remove("timer-ended");
      timerEl.classList.add("paused");
      timerEl.classList.add("resetting");
      setTimeout(()=>{
        elapsed=0;
        renderDigits(fmt(totalSeconds));
        timerEl.classList.remove("resetting");
        resetting = false;
      },600);
    }
    
    function updateTotal(newTotalSeconds) {
        totalSeconds = newTotalSeconds;
        finished = false; // Reset finished state when time is updated
        reset();
    }

    renderDigits(fmt(totalSeconds));
    timerEl.classList.add("paused");
    return {start,pause,reset,updateTotal,
      get running(){return running;}};  
  }

  let timer4 = createTimer("slide-5","timer", 0);
  
  function updateTimerFromSettings() {
    let totalSeconds;
    if (testTimeToggle.checked) {
        totalSeconds = 5;
        timerMinutesInput.disabled = true;
    } else {
        totalSeconds = (parseInt(timerMinutesInput.value, 10) || 0) * 60;
        timerMinutesInput.disabled = false;
    }
    if (timer4) {
        timer4.updateTotal(totalSeconds);
    }
    saveSettings();
  }

  timerMinutesInput.addEventListener('input', updateTimerFromSettings);
  testTimeToggle.addEventListener('change', updateTimerFromSettings);
  timerMinutesInput.addEventListener('blur', () => {
    let value = parseInt(timerMinutesInput.value, 10);
    if (isNaN(value) || value < 1) {
      timerMinutesInput.value = 1;
    } else if (value > 59) {
      timerMinutesInput.value = 59;
    }
    updateTimerFromSettings();
  });


  // === Initial Load ===
  loadSettings();
  loadAudioSetting();

  // === Remote Control (PeerJS) ===
  const PEER_PREFIX = 'ugds-slides-';
  let peer = null;
  let conn = null;
  const peerIdDisplay = document.getElementById('peer-id-display');
  const connectionStatus = document.getElementById('connection-status');

  function initializePeer() {
      const code = Math.floor(100000 + Math.random() * 900000).toString();
      const peerId = PEER_PREFIX + code;
      const peerConfig = {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                {
                    urls: "turn:openrelay.metered.ca:80",
                    username: "openrelayproject",
                    credential: "openrelayproject",
                },
                {
                    urls: "turn:global.turn.twilio.com:3478?transport=udp",
                    username: "7b05221b2b15b3d2b32f3f78c8bd8b656e184895445733348a73f5c5d393f283",
                    credential: "aVv/z1iGz3pPZJ2i3hL9vAUn+sAnb3Iqg2JdJVCmCgM="
                }
            ]
        };
      peer = new Peer(peerId, { config: peerConfig });

      peer.on('open', id => {
          console.log('My peer ID is: ' + id);
          peerIdDisplay.textContent = code;
          const qrLink = document.getElementById('qr-code-link');
          const qrImg = document.getElementById('qr-code-img');
          const remoteUrl = `https://ug-ds.github.io/remote?code=${code}`;
          qrLink.href = remoteUrl;
          qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(remoteUrl)}&color=ED3737&bgcolor=0C1A22&qzone=1`;
      });

      peer.on('connection', newConn => {
          if (conn && conn.open) {
              console.log('Rejecting new connection, already connected.');
              newConn.close();
              return;
          }
          conn = newConn;
          connectionStatus.textContent = 'Remote Connected!';
          connectionStatus.style.color = 'lightgreen';
          console.log('Connected to remote: ' + conn.peer);
          setTimeout(() => {
            conn.send({ type: 'presentation-id', id: '2vs2' });
          }, 500); // Add a small delay to ensure the data channel is ready

          conn.on('data', handleRemoteCommand);
          conn.on('close', () => {
              connectionStatus.textContent = 'Remote Disconnected';
              connectionStatus.style.color = '#999';
              conn = null;
          });
      });

      peer.on('error', err => {
          console.error('PeerJS error:', err);
          peerIdDisplay.textContent = 'Error';
          connectionStatus.textContent = err.type;
      });
  }

  function handleRemoteCommand(data) {
      console.log('Received command:', data);
      const { command, param } = data;
      const t = currentTimer();

      switch (command) {
          case 'showSlide':
              showSlide(parseInt(param));
              break;
          case 'toggleTimer':
              if (t) { if (t.running) t.pause(); else t.start(); }
              break;
          case 'resetTimer':
              if (t) t.reset();
              break;
          // Note: 2v2 doesn't have countdown/overlay, so no case for them.
          // We can add a case for 'Enter' to start the presentation from slide 0.
          case 'special': // The old 'special' button with param 'Enter'
              if (param === 'Enter' && activeIndex === 0) showSlide(4);
              break;
      }
  }


  function currentTimer(){
    if(activeIndex===5)return timer4;
    return null;
  }

  initializePeer();

  // Set last updated time
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hour = String(now.getHours()).padStart(2, '0');
  const minute = String(now.getMinutes()).padStart(2, '0');
  const lastUpdated = `${year}-${month}-${day} ${hour}:${minute}`;
  document.getElementById('version-display').textContent = `Updated: ${lastUpdated}`;

  window.addEventListener("keydown",e=>{
    const k=e.key;

    // Handle Escape key to go to slide 0
    if (k === 'Escape') {
        showSlide(0);
        return;
    }

    // Handle Enter key on slide 0
    if (k === 'Enter' && activeIndex === 0) {
        showSlide(4); // Go to slide 4
        return;
    }

    // If typing in an input, do nothing more
    if (e.target.tagName.toLowerCase() === 'input') {
        return;
    }

    // Handle number keys 1-5 for slides 1-5
    if (/^[1-5]$/.test(k)) {
        // If on slide 0, block navigation
        if (activeIndex === 0) {
            return;
        }
        showSlide(parseInt(k));
        return;
    }

    if(k.toLowerCase()==="r"){const t=currentTimer();if(t)t.reset();return;}

    if(k===" "){
      const t=currentTimer();if(!t)return;
      if(t.running)t.pause();else t.start();
      return;
    }
  });

  let startX=0,startY=0;
  window.addEventListener("touchstart",e=>{
    const t=e.touches[0];startX=t.clientX;startY=t.clientY;
  },{passive:true});
  window.addEventListener("touchend",e=>{
    const t=e.changedTouches[0];
    const dx=t.clientX-startX,dy=t.clientY-startY;
    const absX=Math.abs(dx),absY=Math.abs(dy);
    if(absX>50&&absX>absY){
      if(dx>0)showSlide(activeIndex-1);else showSlide(activeIndex+1);
    }else if(absY>50&&absY>absX){
      const timer=currentTimer();
      if(!timer) return;
      if(dy>0){if(timer.running)timer.pause();else timer.start();}
    }
  },{passive:true});
})();
</script>


</body>
</html>
